#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <windows.h>
#include <conio.h>

#define CORSUR_COLOR 15 // White
#define FRUIT_COLOR 12 // Red
#define BLOCK_COLOR 10 // Green
#define PACMAN_COLOR 14 // Yellow
#define GHOST_COLOR 13
#define WEAK_GHOST_COLOR 9

#define GHOST_SCORE 50
#define FRUIT_SCORE 20
#define BOOST_TIME 10
#define CHOOSE_SLEEP_TIME 300
#define MOVE_SLEEP_TIME 200
#define PRINT_SLEEP_TIME 20
#define MAX 101
#define MROW 100
#define MCOLUMN 100
#define INF (int)8e5 + 1


HANDLE hConsole;
int score = 0;
int boost = 0;
int COLUMN;
int ROW;
int X = 50;
int Y = 0;

//1 -> Fruit
//0 -> Block
//-1 -> Empty
//3 -> Pacman
//2 -> Ghost
//-2 -> Moved Ghost


typedef struct{
	short x;
	short y;
} coord;

void eventManager (int);
int getChoose ();
char flimentPrint (short [MCOLUMN][MROW], int, int, int);
void EndOfGame ();
void hideCursor();
void moveGhosts (short [MCOLUMN][MROW]);
void scanTable (coord*, short [MCOLUMN][MROW], char const*);
int move (coord*, short [MCOLUMN][MROW], int);
void printTable (short [MCOLUMN][MROW]);
void gotoxy (int, int);

int main () {

    int event = 0;
	coord pacman;
	char fileAddress [MAX];
	short table [MCOLUMN][MROW] = { 0 };
	short way [MCOLUMN][MROW] = { 0 };


    hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
    srand(time(NULL));

	printf ("ENTER SOURCE FILE ADDRESS : ");
	gets (fileAddress);

	system ("cls");
    hideCursor();

	scanTable (&pacman, table, fileAddress);

	printTable (table);
    int choice = -1;
    fflush(stdin);
    Sleep (1000);

	while (1) {
        if (boost)
            boost--;
		SetConsoleTextAttribute(hConsole, PACMAN_COLOR);
		gotoxy(pacman.x + X, pacman.y + Y);
        printf("%c", 'C');

        if(kbhit ())
            choice = getChoose ();

        gotoxy(0, 0);
        printf("%3d - %3d", score, boost);
        Sleep(MOVE_SLEEP_TIME);

        gotoxy(pacman.x + X, pacman.y + Y);
        printf(" ");

        moveGhosts(table);
        if (table[pacman.x][pacman.y] == 2) break;

        if(choice)
            event = move(&pacman, table, choice);

        else  break;

        eventManager(event);
	}

	Sleep (1000);

	EndOfGame ();
}
void eventManager (int num) {
    switch (num) {
        case 1:
            score += FRUIT_SCORE;
            boost += BOOST_TIME;
            break;

        case 2:
            if (boost)
                score += GHOST_SCORE;

            else {
                EndOfGame();
                exit(0);
            }
    }
}
int getChoose () {
	int flag = 0;
	char choice = getch();
	if (choice == '-') flag = 1;
	choice = getch();
	if (choice == '1' && flag)
		return 0;

	switch(choice) {
		case 72: return 1;
		case 80: return 2;
		case 75: return 3;
		case 77: return 4;
	}
}
void printTable (short table[MCOLUMN][MROW]) {
	for (int i = 0; i < COLUMN; i++)
		for (int j = 0; j < ROW; j++) {
			char block = ' ';
			int reap = 2;

            SetConsoleTextAttribute(hConsole, CORSUR_COLOR);
            gotoxy (j + X, i + Y);
            printf ("%c", 219);
            Sleep (PRINT_SLEEP_TIME);

            if (!table [i][j]) {
                block = flimentPrint(table, i, j, 0);
                SetConsoleTextAttribute(hConsole, BLOCK_COLOR);
            }
            else if (table [i][j] == 1){
                block = 254;
                SetConsoleTextAttribute(hConsole, FRUIT_COLOR);
            }
            else if (table [i][j] == 2) {
                block = 'G';
                SetConsoleTextAttribute(hConsole, GHOST_COLOR);
            }
            else if (table [i][j] == 3){
                block = 'C';
                SetConsoleTextAttribute(hConsole, PACMAN_COLOR);
            }

            gotoxy (j + X, i + Y);
            printf ("%c", block);
        }
}
int move (coord* pacman, short table [MCOLUMN][MROW], int choice) {
	table[pacman->y][pacman->x] = -1;

	switch (choice) {
		case 1:
			if (pacman->y > 0 && table[pacman->y-1][pacman->x])
				pacman->y--;

			break;

		case 2:
			if (pacman->y + 1 < COLUMN && table[pacman->y+1][pacman->x])
				pacman->y++;

			break;

		case 3:
			if (pacman->x > 0 && table[pacman->y][pacman->x-1])
				pacman->x--;

			break;

		case 4:
			if (pacman->x + 1 < ROW && table[pacman->y][pacman->x+1])
				pacman->x++;
	}
    int tmp = table[pacman->y][pacman->x];

	table[pacman->y][pacman->x] = 3;
	return tmp;
}
void gotoxy(int x,int y){
  HANDLE hConsole;
  COORD cursorLoc;
  cursorLoc.X = x;
  cursorLoc.Y = y;
  hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
  SetConsoleCursorPosition(hConsole, cursorLoc);
}
void scanTable (coord* pacman, short table[MCOLUMN][MROW], char const* fileAddress){
	FILE* source = fopen (fileAddress, "r");

	int i = 0;
	int j = 0;

	if (source == NULL) {
		SetConsoleTextAttribute(hConsole, 76);
		printf ("FIle Not Exist (Oskol) [#_#] \n");
		SetConsoleTextAttribute(hConsole, 15);
		exit (1);
	}
	while (!feof (source)){
		char bfr = getc (source);

		if (bfr == 'G') table [i][j++] = 2;
		if (bfr == '*') table [i][j++] = 1;
		if (bfr == '#') table [i][j++] = 0;
		if (bfr == '1') table [i][j++] = -1;
		if (bfr == '0') {
			table [i][j++] = 3;
			pacman->x = j-1;
			pacman->y = i;
		}

		else if (bfr == '\n') {
			i++;
			if (j > ROW) ROW = j; j = 0;
		}
	}
	COLUMN = i+1;
}
void hideCursor(){
   HANDLE consoleHandle = GetStdHandle(STD_OUTPUT_HANDLE);
   CONSOLE_CURSOR_INFO info;
   info.dwSize = 100;
   info.bVisible = FALSE;
   SetConsoleCursorInfo(consoleHandle, &info);
}
void EndOfGame () {
	gotoxy (0, 0);
	SetConsoleTextAttribute(hConsole, CORSUR_COLOR);
	for (int i = 0; i < COLUMN; i++)
		for (int j = i; j < ROW; j++){
			if (j < ROW && i < COLUMN) {
				gotoxy (j + X, i + Y);
				printf ("%c", 219);
			}
			if (j < COLUMN && i < ROW) {
				gotoxy (i + X, j + Y);
				printf ("%c", 219);
			}

			Sleep (PRINT_SLEEP_TIME);
			gotoxy (j + X, i + Y);
			printf (" ");
			gotoxy (i + X, j + Y);
			printf (" ");
		}

	SetConsoleTextAttribute(hConsole, CORSUR_COLOR);
	gotoxy (X, 0);
	printf ("THE END");
	gotoxy (X, 1);
	printf ("\\[%c-%c]/", 167, 167);
}
char flimentPrint (short table[MCOLUMN][MROW], int i, int j, int p) {
    char block = 0;
    int value = 8 * (j+1 < ROW ? table [i][j+1] == p : 0) + 4 * (j > 0 ? table [i][j-1] == p : 0) + 2 * (i > 0 ? table [i-1][j] == p : 0) + (i+1 < COLUMN ? table [i+1][j] == p : 0);
				switch (value) {
					case 0 : block = 254; break;

					case 1:
					case 2:
					case 3: block = 186; break;

					case 4:
					case 8:
					case 12: block = 205; break;

					case 5: block = 187; break;
					case 6: block = 188; break;

					case 7: block = 185; break;
					case 9: block = 201; break;
					case 10: block = 200; break;

					case 11: block = 204; break;
					case 13: block = 203; break;
					case 14: block = 202; break;
					case 15: block = 206; break;
            }
    return block;
}
void moveGhosts (short table [MCOLUMN][MROW]) {
    for (int i = 0; i < COLUMN; i++)
        for (int j = 0; j < ROW; j++)
            if (table[i][j] == 2){

                coord ghost = {j, i};
                gotoxy (X + j, Y + i);
                printf (" ");

                move (&ghost, table, rand()%4 + 1);

                if (boost) SetConsoleTextAttribute (hConsole, WEAK_GHOST_COLOR);
                else SetConsoleTextAttribute(hConsole, GHOST_COLOR);

                gotoxy (ghost.x + X, ghost.y + Y);
                printf ("G");
                table [ghost.y][ghost.x] = -2;
        }

    for (int i = 0; i < COLUMN; i++)
        for (int j = 0; j < ROW; j++)
            if (table[i][j] == -2)
                table[i][j] = 2;
}
